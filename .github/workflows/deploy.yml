name: Deploy to VPS IDCloudHost

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 103.139.193.218
        username: adminfillahi
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "ğŸš€ Starting deployment..."

          # Navigate to project directory
          cd /var/www/sppd_kpu

          echo "ğŸ“¥ Pulling latest changes..."
          git pull origin main

          echo "ğŸ“¦ Installing PHP dependencies..."
          composer install --no-dev --optimize-autoloader

          echo "ğŸ“¦ Installing Node.js dependencies..."
          npm install

          echo "ğŸ”¨ Building frontend assets..."
          npm run build

          echo "ğŸ—„ï¸ Running database migrations..."
          php artisan migrate --force

          echo "ğŸ§¹ Clearing caches..."
          php artisan config:clear
          php artisan cache:clear
          php artisan view:clear
          php artisan route:clear

          echo "ğŸ”„ Reloading services..."
          sudo systemctl reload nginx
          sudo systemctl reload php8.2-fpm

          echo "âœ… Deployment completed successfully!"

          # Show deployment info
          echo "ğŸŒ Application URL: http://103.139.193.218"
          echo "ğŸ“… Deployment time: $(date)"
