class d{constructor(t){this.data=t,this.charts={},this.initialize()}initialize(){if(typeof Chart>"u"){console.error("Chart.js is not loaded!");return}this.initializeMonthlyChart(),this.initializeStatusChart(),console.log("Dashboard charts initialized successfully")}initializeMonthlyChart(){const t=document.getElementById("monthlyChart");if(!t)return;const i=this.data.months.length>0?this.data.months:this.getDefaultMonths(),a=this.data.monthlyApproved.length>0?this.data.monthlyApproved:this.getDefaultData(),s=this.data.monthlyInReview.length>0?this.data.monthlyInReview:this.getDefaultData(),n=this.data.monthlyRejected.length>0?this.data.monthlyRejected:this.getDefaultData(),r=this.data.monthlySubmitted.length>0?this.data.monthlySubmitted:this.getDefaultData();this.charts.monthly=new Chart(t.getContext("2d"),{type:"line",data:{labels:i,datasets:[{label:"SPPD Disetujui",data:a,borderColor:"#10B981",backgroundColor:"rgba(16,185,129,0.1)",tension:.4,fill:!0,borderWidth:3,pointBackgroundColor:"#10B981",pointBorderColor:"#ffffff",pointBorderWidth:2,pointRadius:5},{label:"SPPD Diajukan",data:s,borderColor:"#F59E0B",backgroundColor:"rgba(245,158,11,0.1)",tension:.4,fill:!0,borderWidth:3,pointBackgroundColor:"#F59E0B",pointBorderColor:"#ffffff",pointBorderWidth:2,pointRadius:5},{label:"SPPD Ditolak",data:n,borderColor:"#EF4444",backgroundColor:"rgba(239,68,68,0.1)",tension:.4,fill:!0,borderWidth:3,pointBackgroundColor:"#EF4444",pointBorderColor:"#ffffff",pointBorderWidth:2,pointRadius:5},{label:"Total Diajukan",data:r,borderColor:"#3B82F6",backgroundColor:"rgba(59,130,246,0.1)",tension:.4,fill:!0,borderWidth:3,pointBackgroundColor:"#3B82F6",pointBorderColor:"#ffffff",pointBorderWidth:2,pointRadius:5}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}},scales:{y:{beginAtZero:!0}}}})}initializeStatusChart(){const t=document.getElementById("statusChart");if(!t)return;const i=this.data.statusDistribution;this.charts.status=new Chart(t.getContext("2d"),{type:"doughnut",data:{labels:["Disetujui","Ditinjau","Ditolak","Selesai"],datasets:[{data:[i.approved||1,i.in_review||1,i.rejected||1,i.completed||3],backgroundColor:["#3B82F6","#F59E0B","#EC4899","#10B981"],borderWidth:0,hoverOffset:20}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}}}})}updateCharts(t){this.data={...this.data,...t},this.charts.monthly&&this.charts.monthly.destroy(),this.charts.status&&this.charts.status.destroy(),this.initializeMonthlyChart(),this.initializeStatusChart()}getDefaultMonths(){return["Jul 2024","Agu 2024","Sep 2024","Okt 2024","Nov 2024","Des 2024","Jan 2025","Feb 2025","Mar 2025","Apr 2025","Mei 2025","Jun 2025"]}getDefaultData(){return[0,0,0,0,0,0,0,0,0,0,0,0]}destroy(){Object.values(this.charts).forEach(t=>{t&&t.destroy()}),this.charts={}}}class h{constructor(){this.elements=this.initializeElements()}initializeElements(){return{approved:document.getElementById("approved-count"),pending:document.getElementById("pending-count"),review:document.getElementById("review-count"),document:document.getElementById("document-count")}}updateStatistics(t){t.statistics&&(t=t.statistics),this.elements.approved&&(this.elements.approved.textContent=t.completed??t.approved??0),this.elements.pending&&(this.elements.pending.textContent=t.pending??0),this.elements.review&&(this.elements.review.textContent=t.review??0),this.elements.document&&(this.elements.document.textContent=t.documents??t.document??0)}}window.DashboardManager={charts:null,statistics:null,init(e){this.charts=new d(e),this.statistics=new h,console.log("Dashboard Manager initialized"),console.log("Data received:",e)},refresh(e){this.charts&&this.charts.updateCharts(e),this.statistics&&this.statistics.updateStatistics(e.statusDistribution||{})},destroy(){this.charts&&this.charts.destroy()}};function o(){fetch("/api/dashboard/realtime").then(e=>{const t=e.headers.get("content-type");if(t&&t.includes("application/json"))return e.json();throw new Error("Not authenticated or invalid response")}).then(e=>{e&&e.success&&e.data&&window.DashboardManager&&window.DashboardManager.refresh({months:e.data.monthly_trend.months,monthlyApproved:e.data.monthly_trend.completed,monthlySubmitted:e.data.monthly_trend.in_review,statusDistribution:{approved:e.data.statistics.completed,pending:e.data.statistics.pending,review:e.data.statistics.review,document:e.data.statistics.documents}})}).catch(e=>{console.error("Failed to fetch realtime dashboard data:",e)})}setInterval(o,6e4);o();
