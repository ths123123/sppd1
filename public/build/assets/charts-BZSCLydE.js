class d{constructor(e){this.data=e,this.charts={},this.initialize()}initialize(){if(typeof Chart>"u"){console.error("Chart.js is not loaded!");return}this.initializeMonthlyChart(),this.initializeStatusChart(),console.log("Dashboard charts initialized successfully")}initializeMonthlyChart(){const e=document.getElementById("monthlyChart");if(!e)return;const s=this.data.months.length>0?this.data.months:this.getDefaultMonths(),i=this.data.monthlyApproved.length>0?this.data.monthlyApproved:this.getDefaultData(),a=this.data.monthlyInReview.length>0?this.data.monthlyInReview:this.getDefaultData(),o=this.data.monthlyRejected.length>0?this.data.monthlyRejected:this.getDefaultData(),n=this.data.monthlySubmitted.length>0?this.data.monthlySubmitted:this.getDefaultData();this.charts.monthly=new Chart(e.getContext("2d"),{type:"line",data:{labels:s,datasets:[{label:"SPPD Disetujui",data:i,borderColor:"#10B981",backgroundColor:"rgba(16,185,129,0.1)",tension:.4,fill:!0,borderWidth:3,pointBackgroundColor:"#10B981",pointBorderColor:"#ffffff",pointBorderWidth:2,pointRadius:5},{label:"SPPD Diajukan",data:a,borderColor:"#F59E0B",backgroundColor:"rgba(245,158,11,0.1)",tension:.4,fill:!0,borderWidth:3,pointBackgroundColor:"#F59E0B",pointBorderColor:"#ffffff",pointBorderWidth:2,pointRadius:5},{label:"SPPD Ditolak",data:o,borderColor:"#EF4444",backgroundColor:"rgba(239,68,68,0.1)",tension:.4,fill:!0,borderWidth:3,pointBackgroundColor:"#EF4444",pointBorderColor:"#ffffff",pointBorderWidth:2,pointRadius:5},{label:"Total Diajukan",data:n,borderColor:"#3B82F6",backgroundColor:"rgba(59,130,246,0.1)",tension:.4,fill:!0,borderWidth:3,pointBackgroundColor:"#3B82F6",pointBorderColor:"#ffffff",pointBorderWidth:2,pointRadius:5}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}},scales:{y:{beginAtZero:!0}}}})}initializeStatusChart(){const e=document.getElementById("statusChart");if(!e)return;const s=this.data.statusDistribution;this.charts.status=new Chart(e.getContext("2d"),{type:"doughnut",data:{labels:["Disetujui","Diajukan","Ditinjau","Ditolak"],datasets:[{data:[s.approved||1,s.submitted||2,s.in_review||1,s.rejected||1],backgroundColor:["#10B981","#3B82F6","#F59E0B","#EC4899"],borderWidth:0,hoverOffset:20}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}}}})}updateCharts(e){this.data={...this.data,...e},this.charts.monthly&&this.charts.monthly.destroy(),this.charts.status&&this.charts.status.destroy(),this.initializeMonthlyChart(),this.initializeStatusChart()}getDefaultMonths(){return["Jul 2024","Agu 2024","Sep 2024","Okt 2024","Nov 2024","Des 2024","Jan 2025","Feb 2025","Mar 2025","Apr 2025","Mei 2025","Jun 2025"]}getDefaultData(){return[0,0,0,0,0,0,0,0,0,0,0,0]}destroy(){Object.values(this.charts).forEach(e=>{e&&e.destroy()}),this.charts={}}}class l{constructor(){this.elements=this.initializeElements()}initializeElements(){return{approved:document.getElementById("approved-count"),pending:document.getElementById("submitted-count"),review:document.getElementById("review-count"),document:document.getElementById("document-count")}}updateStatistics(e){e.statistics&&(e=e.statistics),this.elements.approved&&(this.elements.approved.textContent=e.completed??e.approved??0),this.elements.pending&&(this.elements.pending.textContent=e.submitted??0),this.elements.review&&(this.elements.review.textContent=e.review??0),this.elements.document&&(this.elements.document.textContent=e.documents??e.document??0)}}window.DashboardManager={charts:null,statistics:null,init(t){this.charts=new d(t),this.statistics=new l,console.log("Dashboard Manager initialized"),console.log("Data received:",t)},refresh(t){this.charts&&this.charts.updateCharts(t),this.statistics&&this.statistics.updateStatistics(t.statusDistribution||{})},destroy(){this.charts&&this.charts.destroy()}};function h(t){const e=document.querySelector("#recent-activities-container");if(e)if(e.innerHTML="",t&&t.length>0){let s="";t.forEach(i=>{let a="bg-blue-100",o="text-blue-600",n="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2";i.status==="completed"?(a="bg-green-100",o="text-green-600",n="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"):i.status==="rejected"?(a="bg-red-100",o="text-red-600",n="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"):i.status==="in_review"?(a="bg-purple-100",o="text-purple-600",n="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"):i.status==="revision"?(a="bg-yellow-100",o="text-yellow-600",n="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"):i.status==="submitted"&&(a="bg-blue-100",o="text-blue-600",n="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"),s+=`
            <div class="px-6 py-5 flex items-start hover:bg-gray-50 transition-colors duration-150">
                <div class="flex-shrink-0">
                    <span class="h-12 w-12 rounded-full ${a} flex items-center justify-center shadow-md">
                        <svg class="h-7 w-7 ${o}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${n}" />
                        </svg>
                    </span>
                </div>
                <div class="ml-5 flex-1">
                    <div class="flex justify-between items-start">
                        <p class="text-sm font-medium text-gray-900">${i.description||"Aktivitas SPPD"}</p>
                        <span class="text-xs text-gray-500 ml-2 whitespace-nowrap font-medium">${i.time_ago||i.updated_at_diff||""}</span>
                    </div>
                    <div class="mt-1">
                        <p class="text-xs text-gray-500">
                            <span class="font-medium">${i.kode_sppd||"No. SPPD belum tersedia"}</span> 
                            ${i.tujuan?`- ${i.tujuan}`:""}
                        </p>
                    </div>
                    ${i.approver_name?`
                    <div class="mt-1">
                        <p class="text-xs text-gray-500">
                            <span class="font-medium">Diproses oleh: ${i.approver_name}</span>
                            ${i.approver_role?`(${i.approver_role})`:""}
                        </p>
                    </div>`:""}
                </div>
            </div>
            `}),e.innerHTML=s}else e.innerHTML=`
            <div class="flex flex-col items-center justify-center py-10 px-6 text-center">
                <svg class="h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">Belum ada aktivitas terbaru</h3>
                <p class="mt-1 text-sm text-gray-500">Aktivitas SPPD terbaru akan muncul di sini.</p>
            </div>
        `}function r(){fetch("/api/dashboard/realtime",{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json","Content-Type":"application/json","Cache-Control":"no-cache"},credentials:"same-origin"}).then(t=>{if(t.status===401)throw new Error("Not authenticated. Please login again.");if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);const e=t.headers.get("content-type");if(e&&e.includes("application/json"))return t.json();throw new Error("Invalid response format")}).then(t=>{if(t&&t.success&&t.data){window.DashboardManager&&window.DashboardManager.refresh({months:t.data.monthly_trend.months,monthlyApproved:t.data.monthly_trend.completed,monthlyInReview:t.data.monthly_trend.in_review,monthlyRejected:t.data.monthly_trend.rejected,monthlySubmitted:t.data.monthly_trend.submitted,statusDistribution:{approved:t.data.statistics.completed,submitted:t.data.statistics.submitted,review:t.data.statistics.review,rejected:t.data.statistics.rejected,document:t.data.statistics.documents,completed:t.data.statistics.completed}}),h(t.data.recent_activities),document.getElementById("approved-count").textContent=t.data.statistics.completed||0,document.getElementById("rejected-count").textContent=t.data.statistics.rejected||0,document.getElementById("review-count").textContent=t.data.statistics.review||0,document.getElementById("submitted-count").textContent=t.data.statistics.submitted||0;const e=document.querySelector(".text-white.text-lg.font-bold");e&&(e.textContent=new Date().toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"}));const s=document.querySelector(".text-white.text-opacity-80.text-sm");s&&(s.textContent=new Date().toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit",second:"2-digit"})+" WIB")}}).catch(t=>{console.error("Failed to fetch realtime dashboard data:",t),t.message.includes("Not authenticated")&&(window.location.href="/login")})}setInterval(r,6e4);r();
