class j{constructor(){this.storageKey="dashboard_activities_backup",this.mutex=!1,this.lastApiCall=0,this.minApiInterval=1e4,this.activities=[],this.isInitialized=!1,this.backupInterval=null,this.initialize()}initialize(){console.log("üîß Initializing Activity Preservation System..."),this.loadFromStorage(),this.startPeriodicBackup(),this.isInitialized=!0,console.log("‚úÖ Activity Preservation System initialized")}async acquireLock(){return this.mutex?(console.log("üîí Mutex already locked, waiting..."),!1):(this.mutex=!0,console.log("üîí Mutex acquired"),!0)}releaseLock(){this.mutex=!1,console.log("üîì Mutex released")}canMakeApiCall(){const e=Date.now()-this.lastApiCall;return e<this.minApiInterval?(console.log(`‚è∞ API call throttled: ${Math.round(e/1e3)}s < ${this.minApiInterval/1e3}s`),!1):!0}saveToStorage(t){try{if(typeof localStorage<"u"){const e={activities:t,timestamp:Date.now(),version:"1.0"};localStorage.setItem(this.storageKey,JSON.stringify(e)),console.log("üíæ Activities saved to localStorage")}}catch(e){console.warn("‚ö†Ô∏è Failed to save to localStorage:",e)}}loadFromStorage(){try{if(typeof localStorage<"u"){const t=localStorage.getItem(this.storageKey);if(t){const e=JSON.parse(t);if(Date.now()-e.timestamp<36e5&&e.activities&&Array.isArray(e.activities))return this.activities=e.activities,console.log("üìÇ Loaded activities from localStorage:",this.activities.length),!0;console.log("üóëÔ∏è Stored activities too old, clearing localStorage"),localStorage.removeItem(this.storageKey)}}}catch(t){console.warn("‚ö†Ô∏è Failed to load from localStorage:",t)}return!1}startPeriodicBackup(){this.backupInterval&&clearInterval(this.backupInterval),this.backupInterval=setInterval(()=>{this.activities.length>0&&this.saveToStorage(this.activities)},3e4)}updateActivities(t){return!t||!Array.isArray(t)||t.length===0?(console.log("‚ö†Ô∏è Invalid activities data provided, keeping existing"),!1):(this.activities=t,this.saveToStorage(this.activities),console.log("‚úÖ Activities updated:",this.activities.length),!0)}getActivities(){return this.activities}hasActivities(){return this.activities&&Array.isArray(this.activities)&&this.activities.length>0}destroy(){this.backupInterval&&clearInterval(this.backupInterval),console.log("üßπ Activity Preservation System destroyed")}}const s=new j;class E{constructor(t){this.data=t,this.charts={},this.initialize()}initialize(){if(typeof Chart>"u"){console.error("Chart.js is not loaded!");return}this.initializeMonthlyChart(),this.initializeStatusChart(),console.log("Dashboard charts initialized successfully")}initializeMonthlyChart(){const t=document.getElementById("monthlyChart");if(!t)return;const e=this.data.months.length>0?this.data.months:this.getDefaultMonths(),n=this.data.monthlyApproved.length>0?this.data.monthlyApproved:this.getDefaultData(),a=this.data.monthlyInReview.length>0?this.data.monthlyInReview:this.getDefaultData(),u=this.data.monthlyRejected.length>0?this.data.monthlyRejected:this.getDefaultData(),r=this.data.monthlySubmitted.length>0?this.data.monthlySubmitted:this.getDefaultData();this.charts.monthly=new Chart(t.getContext("2d"),{type:"line",data:{labels:e,datasets:[{label:"SPPD Disetujui",data:n,borderColor:"#10B981",backgroundColor:"rgba(16,185,129,0.1)",tension:.4,fill:!0,borderWidth:3,pointBackgroundColor:"#10B981",pointBorderColor:"#ffffff",pointBorderWidth:2,pointRadius:5},{label:"SPPD Diajukan",data:a,borderColor:"#F59E0B",backgroundColor:"rgba(245,158,11,0.1)",tension:.4,fill:!0,borderWidth:3,pointBackgroundColor:"#F59E0B",pointBorderColor:"#ffffff",pointBorderWidth:2,pointRadius:5},{label:"SPPD Ditolak",data:u,borderColor:"#EF4444",backgroundColor:"rgba(239,68,68,0.1)",tension:.4,fill:!0,borderWidth:3,pointBackgroundColor:"#EF4444",pointBorderColor:"#ffffff",pointBorderWidth:2,pointRadius:5},{label:"Total Diajukan",data:r,borderColor:"#3B82F6",backgroundColor:"rgba(59,130,246,0.1)",tension:.4,fill:!0,borderWidth:3,pointBackgroundColor:"#3B82F6",pointBorderColor:"#ffffff",pointBorderWidth:2,pointRadius:5}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}},scales:{y:{beginAtZero:!0}}}})}initializeStatusChart(){const t=document.getElementById("statusChart");if(!t)return;const e=this.data.statusDistribution;this.charts.status=new Chart(t.getContext("2d"),{type:"doughnut",data:{labels:["Disetujui","Diajukan","Ditinjau","Ditolak"],datasets:[{data:[e.approved||1,e.submitted||2,e.in_review||1,e.rejected||1],backgroundColor:["#10B981","#3B82F6","#F59E0B","#EC4899"],borderWidth:0,hoverOffset:20}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}}}})}updateCharts(t){this.data={...this.data,...t},this.charts.monthly&&this.charts.monthly.destroy(),this.charts.status&&this.charts.status.destroy(),this.initializeMonthlyChart(),this.initializeStatusChart()}getDefaultMonths(){return["Jul 2024","Agu 2024","Sep 2024","Okt 2024","Nov 2024","Des 2024","Jan 2025","Feb 2025","Mar 2025","Apr 2025","Mei 2025","Jun 2025"]}getDefaultData(){return[0,0,0,0,0,0,0,0,0,0,0,0]}destroy(){Object.values(this.charts).forEach(t=>{t&&t.destroy()}),this.charts={}}}class P{constructor(){this.elements=this.initializeElements()}initializeElements(){return{approved:document.getElementById("approved-count"),pending:document.getElementById("submitted-count"),review:document.getElementById("review-count"),document:document.getElementById("document-count")}}updateStatistics(t){t.statistics&&(t=t.statistics),this.elements.approved&&(this.elements.approved.textContent=t.completed??t.approved??0),this.elements.pending&&(this.elements.pending.textContent=t.submitted??0),this.elements.review&&(this.elements.review.textContent=t.review??0),this.elements.document&&(this.elements.document.textContent=t.documents??t.document??0)}}window.DashboardManager={charts:null,statistics:null,init(i){this.charts=new E(i),this.statistics=new P,console.log("Dashboard Manager initialized"),console.log("Data received:",i)},refresh(i){this.charts&&this.charts.updateCharts(i),this.statistics&&this.statistics.updateStatistics(i.statusDistribution||{})},destroy(){this.charts&&this.charts.destroy(),s&&s.destroy()}};function g(){const i=document.querySelector("#recent-activities-container");if(!i){console.error("‚ùå Activity container not found!");return}if(document.querySelectorAll("#recent-activities-container .px-6.py-5").length>0){console.log("üìù Activities already displayed, skipping empty message");return}console.log("üìù Showing empty activity message"),i.innerHTML=`
        <div class="flex flex-col items-center justify-center py-10 px-6 text-center">
            <svg class="h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">Belum ada aktivitas terbaru</h3>
            <p class="mt-1 text-sm text-gray-500">Aktivitas SPPD terbaru akan muncul di sini.</p>
        </div>
    `}function d(i){console.log("üîÑ Updating recent activities with:",i);const t=document.querySelector("#recent-activities-container");if(!t){console.error("‚ùå Activity container not found!");return}if(!i||!Array.isArray(i)||i.length===0){if(console.log("‚ö†Ô∏è Invalid activities data provided"),document.querySelectorAll("#recent-activities-container .px-6.py-5").length>0){console.log("üìù Keeping existing activities - no valid replacement data");return}g();return}s.updateActivities(i);try{if(document.querySelectorAll("#recent-activities-container .px-6.py-5").length===0)console.log("üìã Rendering activities - container was empty"),t.innerHTML="";else{console.log("üìù Activities already displayed, skipping render");return}console.log(`üìã Rendering ${i.length} activities`);let n="";i.forEach((a,u)=>{let r="bg-blue-100",l="text-blue-600",c="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2";a.status==="completed"?(r="bg-green-100",l="text-green-600",c="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"):a.status==="rejected"?(r="bg-red-100",l="text-red-600",c="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"):a.status==="in_review"?(r="bg-purple-100",l="text-purple-600",c="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"):a.status==="revision"?(r="bg-yellow-100",l="text-yellow-600",c="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"):a.status==="submitted"&&(r="bg-blue-100",l="text-blue-600",c="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"),n+=`
            <div class="px-6 py-5 flex items-start hover:bg-gray-50 transition-colors duration-150">
                <div class="flex-shrink-0">
                    <span class="h-12 w-12 rounded-full ${r} flex items-center justify-center shadow-md">
                        <svg class="h-7 w-7 ${l}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${c}" />
                        </svg>
                    </span>
                </div>
                <div class="ml-5 flex-1">
                    <div class="flex justify-between items-start">
                        <p class="text-sm font-medium text-gray-900">${a.description||"Aktivitas SPPD"}</p>
                        <span class="text-xs text-gray-500 ml-2 whitespace-nowrap font-medium">${a.time_ago||a.updated_at_diff||""}</span>
                    </div>
                    <div class="mt-1">
                        <p class="text-xs text-gray-500">
                            <span class="font-medium">${a.kode_sppd||"No. SPPD belum tersedia"}</span>
                            ${a.tujuan?`- ${a.tujuan}`:""}
                        </p>
                    </div>
                    ${a.approver_name?`
                    <div class="mt-1">
                        <p class="text-xs text-gray-500">
                            <span class="font-medium">Diproses oleh: ${a.approver_name}</span>
                            ${a.approver_role?`(${a.approver_role})`:""}
                        </p>
                    </div>`:""}
                </div>
            </div>
            `}),t.innerHTML=n,console.log("‚úÖ Activities rendered successfully")}catch(e){if(console.error("‚ùå Error updating activities:",e),s.hasActivities()){console.log("üîÑ Attempting to restore activities after error");const n=s.getActivities();n.length>0&&d(n)}else document.querySelectorAll("#recent-activities-container .px-6.py-5").length===0&&g()}}async function p(){try{if(console.log("üîÑ Loading recent activities..."),!await s.acquireLock()){console.log("üö´ Activities loading already in progress, skipping");return}if(!s.canMakeApiCall()){console.log("üö´ API call throttled, skipping"),s.releaseLock();return}const i=document.querySelectorAll("#recent-activities-container .px-6.py-5");if(i.length>0){console.log("‚úÖ Activities already displayed, skipping API call"),s.releaseLock();return}s.lastApiCall=Date.now(),console.log("üì° Fetching recent activities from API...");const t=await fetch("/dashboard/recent-activities");if(console.log("Response status:",t.status),t.ok){const e=await t.json();console.log("Response data:",e),e.success&&e.data&&e.data.length>0?(console.log("‚úÖ Activities found:",e.data.length),d(e.data)):(console.warn("‚ö†Ô∏è No activities found or empty response:",e.message),s.hasActivities()?(console.log("üîÑ Restoring activities from system"),d(s.getActivities())):i.length===0&&g())}else console.warn("‚ö†Ô∏è Failed to load recent activities:",t.status),s.hasActivities()?(console.log("üîÑ Restoring activities from system after API failure"),d(s.getActivities())):i.length===0&&g()}catch(i){console.error("‚ùå Error loading recent activities:",i),s.hasActivities()?(console.log("üîÑ Restoring activities from system after error"),d(s.getActivities())):document.querySelectorAll("#recent-activities-container .px-6.py-5").length===0&&g()}finally{s.releaseLock()}}async function M(){var i,t,e,n,a,u,r,l,c,m,v,f,y,A,b;try{if(console.log("üì° Fetching realtime dashboard data..."),!await s.acquireLock()){console.log("üö´ Dashboard refresh already in progress, skipping");return}if(!s.canMakeApiCall()){console.log("üö´ API call throttled, skipping dashboard refresh"),s.releaseLock();return}s.lastApiCall=Date.now();const h=await fetch("/api/dashboard/realtime",{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json","Content-Type":"application/json","Cache-Control":"no-cache"},credentials:"same-origin"});if(h.status===401)throw new Error("Not authenticated. Please login again.");if(!h.ok)throw new Error(`HTTP error! Status: ${h.status}`);const w=h.headers.get("content-type");if(!w||!w.includes("application/json"))throw new Error("Invalid response format");const o=await h.json();if(o&&o.success&&o.data){if(window.DashboardManager)try{window.DashboardManager.refresh({months:((i=o.data.monthly_trend)==null?void 0:i.months)||[],monthlyApproved:((t=o.data.monthly_trend)==null?void 0:t.completed)||[],monthlyInReview:((e=o.data.monthly_trend)==null?void 0:e.in_review)||[],monthlyRejected:((n=o.data.monthly_trend)==null?void 0:n.rejected)||[],monthlySubmitted:((a=o.data.monthly_trend)==null?void 0:a.submitted)||[],statusDistribution:{approved:((u=o.data.statistics)==null?void 0:u.completed)||0,submitted:((r=o.data.statistics)==null?void 0:r.submitted)||0,review:((l=o.data.statistics)==null?void 0:l.review)||0,rejected:((c=o.data.statistics)==null?void 0:c.rejected)||0,document:((m=o.data.statistics)==null?void 0:m.documents)||0,completed:((v=o.data.statistics)==null?void 0:v.completed)||0}})}catch(B){console.warn("DashboardManager refresh failed:",B)}o.data.recent_activities&&Array.isArray(o.data.recent_activities)&&o.data.recent_activities.length>0?(console.log("üìä Updating recent activities from realtime dashboard"),d(o.data.recent_activities)):(console.log("üìä No valid recent activities in realtime data, keeping existing"),document.querySelectorAll("#recent-activities-container .px-6.py-5").length===0&&s.hasActivities()&&(console.log("üîÑ Restoring activities from system"),d(s.getActivities())));const x=document.getElementById("approved-count"),k=document.getElementById("rejected-count"),C=document.getElementById("review-count"),S=document.getElementById("submitted-count");x&&(x.textContent=((f=o.data.statistics)==null?void 0:f.completed)||0),k&&(k.textContent=((y=o.data.statistics)==null?void 0:y.rejected)||0),C&&(C.textContent=((A=o.data.statistics)==null?void 0:A.review)||0),S&&(S.textContent=((b=o.data.statistics)==null?void 0:b.submitted)||0);const D=document.querySelector(".text-white.text-lg.font-bold");D&&(D.textContent=new Date().toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"}));const I=document.querySelector(".text-white.text-opacity-80.text-sm");I&&(I.textContent=new Date().toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit",second:"2-digit"})+" WIB"),console.log("‚úÖ Realtime dashboard data updated successfully")}}catch(h){console.error("‚ùå Failed to fetch realtime dashboard data:",h),h.message.includes("Not authenticated")&&(window.location.href="/login")}finally{s.releaseLock()}}setInterval(()=>{if(!s.isInitialized){console.log("üö´ Activity system not initialized, skipping auto-refresh");return}if(!s.canMakeApiCall()){console.log("üö´ Auto-refresh throttled, skipping");return}document.querySelectorAll("#recent-activities-container .px-6.py-5").length===0&&s.hasActivities()?(console.log("üîÑ Auto-refresh: Restoring activities from system"),d(s.getActivities())):(console.log("üîÑ Auto-refresh dashboard data"),M())},3e5);window.activitiesLocked=!1;window.apiCallInProgress=!1;window.preventActivityClear=!0;window.lastSuccessfulRefreshTime=Date.now();console.log("üîç Activity Preservation System Status:");console.log("- System initialized:",s.isInitialized);console.log("- Activities stored:",s.hasActivities());console.log("- Activities count:",s.getActivities().length);document.addEventListener("DOMContentLoaded",()=>{console.log("üöÄ DOM Content Loaded - Initializing enhanced dashboard...");const i=document.querySelectorAll("#recent-activities-container .px-6.py-5");if(i.length>0){console.log("‚úÖ Backend provided activities, storing in system");const t=Array.from(i).map(e=>{var n;return{description:((n=e.querySelector(".text-sm.font-medium"))==null?void 0:n.textContent)||"Aktivitas SPPD",status:"submitted",kode_sppd:"SPPD-"+Math.random().toString(36).substr(2,9),time_ago:"Baru saja"}});s.updateActivities(t),console.log("üìä Backend activities stored in system:",t.length)}else console.log("üîÑ No backend activities, will load via JavaScript"),setTimeout(()=>{typeof p=="function"&&p()},1e3);if(window.DashboardManager){const t={months:[],monthlyApproved:[],monthlyInReview:[],monthlyRejected:[],monthlySubmitted:[],statusDistribution:{approved:0,submitted:0,in_review:0,rejected:0,completed:0}};window.DashboardManager.init(t)}console.log("üéØ Enhanced Dashboard SPPD KPU Kabupaten Cirebon - Stability Version Active")});window.loadRecentActivities=p;window.updateRecentActivities=d;window.fetchRealtimeDashboard=M;
