class T{constructor(){this.charts={},this.periodSelector=document.querySelector('select[name="period"]'),this.init()}init(){this.periodSelector&&this.periodSelector.addEventListener("change",t=>{this.fetchAndRender(t.target.value)}),this.fetchAndRender(this.periodSelector?this.periodSelector.value:"12"),this.bindChartClicks(),this.bindModalClose()}async fetchAndRender(t){try{const a=await(await fetch(`/analytics/data?period=${t}`)).json();if(a.error)throw new Error(a.error);this.renderAll(a);const n=new Date().toLocaleString("id-ID",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"}),s=document.getElementById("last-updated");s&&(s.innerText=n)}catch(e){this.showError("Gagal memuat data analytics: "+e.message)}}renderAll(t){this.renderMonthlyTrends(t.monthlyTrends),this.renderBudgetTrends(t.monthlyTrends),this.renderStatusDistribution(t.statusDistribution),this.renderDepartmentAnalysis(t.departmentAnalysis),this.renderApprovalPerformance(t.approvalPerformance),this.renderTopDestinations(t.trendingData.top_destinations),this.renderBudgetUtilization(t.overview&&t.overview.budget_utilization?t.overview.budget_utilization:null),this.renderInsights(t)}renderMonthlyTrends(t){const e=document.getElementById("monthlyTrendsChart");if(!e)return;const a=(t||[]).map(s=>s.period),i=(t||[]).map(s=>s.sppd_count),n=(t||[]).map(s=>s.approved_count||0);this.charts.monthlyTrends&&this.charts.monthlyTrends.destroy(),this.charts.monthlyTrends=new Chart(e,{type:"line",data:{labels:a,datasets:[{label:"Total SPPD",data:i,borderColor:"rgb(59, 130, 246)",backgroundColor:"rgba(59, 130, 246, 0.1)",tension:.4},{label:"Disetujui",data:n,borderColor:"rgb(34, 197, 94)",backgroundColor:"rgba(34, 197, 94, 0.1)",tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0}},scales:{y:{beginAtZero:!0}}}}),a.length||this.showEmpty(e,"Tidak ada data tren bulanan")}renderBudgetTrends(t){const e=document.getElementById("budgetTrendsChart");if(!e)return;const a=(t||[]).map(n=>n.period),i=(t||[]).map(n=>n.total_budget);this.charts.budgetTrends&&this.charts.budgetTrends.destroy(),this.charts.budgetTrends=new Chart(e,{type:"bar",data:{labels:a,datasets:[{label:"Anggaran (Rp)",data:i,backgroundColor:"rgba(16, 185, 129, 0.8)",borderColor:"rgb(16, 185, 129)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,ticks:{callback:function(n){return"Rp "+n.toLocaleString()}}}}}}),a.length||this.showEmpty(e,"Tidak ada data anggaran")}renderStatusDistribution(t){const e=document.getElementById("statusChart");if(!e)return;const a=Object.keys(t||{}),i=Object.values(t||{});this.charts.status&&this.charts.status.destroy(),this.charts.status=new Chart(e,{type:"doughnut",data:{labels:a,datasets:[{data:i,backgroundColor:["rgba(34, 197, 94, 0.8)","rgba(239, 68, 68, 0.8)","rgba(59, 130, 246, 0.8)","rgba(245, 158, 11, 0.8)","rgba(139, 92, 246, 0.8)"],borderWidth:2,borderColor:"#fff"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}}}}),a.length||this.showEmpty(e,"Tidak ada data status")}renderDepartmentAnalysis(t){const e=document.getElementById("departmentAnalysisChart");if(!e)return;const a=(t||[]).map(s=>s.department),i=(t||[]).map(s=>s.total_requests),n=(t||[]).map(s=>s.approved_count);this.charts.department&&this.charts.department.destroy(),this.charts.department=new Chart(e,{type:"bar",data:{labels:a,datasets:[{label:"Total SPPD",data:i,backgroundColor:"rgba(59, 130, 246, 0.7)"},{label:"Disetujui",data:n,backgroundColor:"rgba(34, 197, 94, 0.7)"}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0}},scales:{x:{beginAtZero:!0}}}}),a.length||this.showEmpty(e,"Tidak ada data departemen")}renderApprovalPerformance(t){const e=document.getElementById("approvalPerformanceChart");if(!e)return;const a=(t||[]).map(n=>n.approver_name),i=(t||[]).map(n=>n.total_approvals);this.charts.approval&&this.charts.approval.destroy(),this.charts.approval=new Chart(e,{type:"pie",data:{labels:a,datasets:[{data:i,backgroundColor:["rgba(59, 130, 246, 0.7)","rgba(34, 197, 94, 0.7)","rgba(245, 158, 11, 0.7)","rgba(239, 68, 68, 0.7)","rgba(139, 92, 246, 0.7)"]}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}}}}),a.length||this.showEmpty(e,"Tidak ada data approval")}renderTopDestinations(t){const e=document.getElementById("topDestinationsChart");if(!e)return;const a=(t||[]).map(n=>n.tujuan),i=(t||[]).map(n=>n.count);this.charts.destinations&&this.charts.destinations.destroy(),this.charts.destinations=new Chart(e,{type:"bar",data:{labels:a,datasets:[{label:"Jumlah Kunjungan",data:i,backgroundColor:"rgba(59, 130, 246, 0.7)"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0}}}}),a.length||this.showEmpty(e,"Tidak ada data destinasi")}renderBudgetUtilization(t){const e=document.getElementById("budgetUtilizationChart");if(!e||!t)return;const a=t.used||0,i=t.remaining||0;this.charts.budgetUtilization&&this.charts.budgetUtilization.destroy(),this.charts.budgetUtilization=new Chart(e,{type:"doughnut",data:{labels:["Terpakai","Sisa"],datasets:[{data:[a,i],backgroundColor:["rgba(34, 197, 94, 0.8)","rgba(59, 130, 246, 0.8)"],borderWidth:2,borderColor:"#fff"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}}}})}renderInsights(t){const e=t.monthlyTrends||[];let a="Belum ada data SPPD.";if(e.length>1){const r=e[e.length-1],p=e[e.length-2],c=r.sppd_count-p.sppd_count;c>0?a=`Jumlah SPPD bulan ${r.period} meningkat ${c} dibanding bulan sebelumnya.`:c<0?a=`Jumlah SPPD bulan ${r.period} menurun ${Math.abs(c)} dibanding bulan sebelumnya.`:a=`Jumlah SPPD bulan ${r.period} sama dengan bulan sebelumnya.`}else e.length===1&&(a=`Terdapat ${e[0].sppd_count} SPPD pada ${e[0].period}.`);document.getElementById("insight-monthly").innerText=a;function i(r){return"Rp "+Number(r).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}let n="Belum ada data anggaran.";if(e.length>1){const r=e[e.length-1],p=e[e.length-2],c=r.total_budget-p.total_budget;c>0?n=`Total anggaran bulan ${r.period} naik ${i(c)} dibanding bulan sebelumnya.`:c<0?n=`Total anggaran bulan ${r.period} turun ${i(Math.abs(c))} dibanding bulan sebelumnya.`:n=`Total anggaran bulan ${r.period} sama dengan bulan sebelumnya.`}else e.length===1&&(n=`Total anggaran bulan ${e[0].period}: ${i(e[0].total_budget)}.`);document.getElementById("insight-budget").innerText=n;const s=t.statusDistribution||{};let d=null,l=0,o=0;Object.entries(s).forEach(([r,p])=>{p>l&&(l=p,d=r),o+=p});let h="Belum ada data status.";d&&(h=`Status SPPD terbanyak adalah "${d}" (${l} dari ${o} SPPD).`),document.getElementById("insight-status").innerText=h;const u=t.departmentAnalysis||[];let m="Belum ada data departemen.";if(u.length>0){const r=u.reduce((p,c)=>p.total_requests>c.total_requests?p:c);m=`Departemen dengan SPPD terbanyak: ${r.department} (${r.total_requests} SPPD).`}document.getElementById("insight-department").innerText=m;const b=t.approvalPerformance||[];let y="Belum ada data approval.";if(b.length>0){const r=b.reduce((p,c)=>p.total_approvals>c.total_approvals?p:c);y=`Approval terbanyak oleh ${r.approver_name} (${r.total_approvals} approval).`}document.getElementById("insight-approval").innerText=y;const f=t.trendingData&&t.trendingData.top_destinations?t.trendingData.top_destinations:[];let v="Belum ada data destinasi.";if(f.length>0){const r=f[0];v=`Destinasi paling populer: ${r.tujuan} (${r.count} kali perjalanan).`}document.getElementById("insight-destination").innerText=v;const g=t.overview&&t.overview.budget_utilization?t.overview.budget_utilization:null;let E="Belum ada data utilisasi anggaran.";g&&(E=`Anggaran terpakai: ${i(g.used)} dari total alokasi ${i(g.allocated)} (${g.utilization_rate}% terpakai).`),document.getElementById("insight-utilization").innerText=E}showEmpty(t,e){if(t&&t.parentNode){t.parentNode.querySelectorAll(".empty-chart-msg").forEach(i=>i.remove());const a=document.createElement("div");a.className="empty-chart-msg",a.style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#888;text-align:center;z-index:10;pointer-events:none;",a.innerText=e,t.parentNode.appendChild(a)}}showError(t){alert(t)}bindChartClicks(){const t=document.getElementById("monthlyTrendsChart");t&&(t.onclick=l=>{const o=this.charts.monthlyTrends.getElementsAtEventForMode(l,"nearest",{intersect:!0},!0);if(o.length){const h=o[0].index,u=this.charts.monthlyTrends.data.labels[h];this.showDetailModal("monthly",{period:u})}});const e=document.getElementById("budgetTrendsChart");e&&(e.onclick=l=>{const o=this.charts.budgetTrends.getElementsAtEventForMode(l,"nearest",{intersect:!0},!0);if(o.length){const h=o[0].index,u=this.charts.budgetTrends.data.labels[h];this.showDetailModal("budget",{period:u})}});const a=document.getElementById("statusChart");a&&(a.onclick=l=>{const o=this.charts.status.getElementsAtEventForMode(l,"nearest",{intersect:!0},!0);if(o.length){const h=o[0].index,u=this.charts.status.data.labels[h];this.showDetailModal("status",{status:u})}});const i=document.getElementById("departmentAnalysisChart");i&&(i.onclick=l=>{const o=this.charts.department.getElementsAtEventForMode(l,"nearest",{intersect:!0},!0);if(o.length){const h=o[0].index,u=this.charts.department.data.labels[h];this.showDetailModal("department",{department:u})}});const n=document.getElementById("approvalPerformanceChart");n&&(n.onclick=l=>{const o=this.charts.approval.getElementsAtEventForMode(l,"nearest",{intersect:!0},!0);if(o.length){const h=o[0].index,u=this.charts.approval.data.labels[h];this.showDetailModal("approval",{approver:u})}});const s=document.getElementById("topDestinationsChart");s&&(s.onclick=l=>{const o=this.charts.destinations.getElementsAtEventForMode(l,"nearest",{intersect:!0},!0);if(o.length){const h=o[0].index,u=this.charts.destinations.data.labels[h];this.showDetailModal("destination",{tujuan:u})}});const d=document.getElementById("budgetUtilizationChart");d&&(d.onclick=()=>{this.showDetailModal("utilization",{})})}showDetailModal(t,e){const a=document.getElementById("analytics-modal"),i=document.getElementById("analytics-modal-content");a.classList.remove("hidden"),i.innerHTML="<div class='text-center text-lg font-bold mb-4'>Memuat detail...</div>",i.dataset.detailType=t,i.dataset.detailParams=JSON.stringify(e);const n=new URL("/analytics/detail",window.location.origin);n.searchParams.set("type",t),Object.entries(e).forEach(([s,d])=>n.searchParams.set(s,d)),fetch(n).then(s=>s.json()).then(s=>{let d=`<div class='text-xl font-bold mb-2'>${s.title}</div>`;s.columns&&s.columns.length?(d+="<div class='overflow-x-auto'><table class='min-w-full text-sm border rounded-lg'>",d+=`<thead><tr>${s.columns.map(l=>`<th class='px-3 py-2 bg-slate-100 border-b text-left'>${l}</th>`).join("")}</tr></thead>`,d+="<tbody>",s.data&&s.data.length?s.data.forEach(l=>{d+=`<tr>${l.map(o=>`<td class='px-3 py-2 border-b'>${o}</td>`).join("")}</tr>`}):d+=`<tr><td colspan='${s.columns.length}' class='text-center py-4 text-gray-400'>Tidak ada data.</td></tr>`,d+="</tbody></table></div>"):d+="<div class='text-gray-400 text-center py-8'>Tidak ada data detail.</div>",i.innerHTML=d}).catch(()=>{i.innerHTML="<div class='text-red-500 text-center py-8'>Gagal memuat detail data.</div>"})}bindModalClose(){const t=document.getElementById("analytics-modal"),e=document.getElementById("close-analytics-modal");e&&(e.onclick=()=>{t.classList.add("hidden")}),t.addEventListener("click",a=>{a.target===t&&t.classList.add("hidden")})}}document.getElementById("monthlyTrendsChart")&&(window.analyticsPage=new T);
