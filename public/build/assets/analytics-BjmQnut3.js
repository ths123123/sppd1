class x{constructor(){this.charts={},this.periodSelector=document.querySelector('select[name="period"]'),this.init()}init(){console.log("AnalyticsPage init started");const n=["monthlyTrendsChart","total-sppd","approved-sppd","rejected-sppd","review-sppd","total-change","approved-change","rejected-change","review-change"].filter(s=>!document.getElementById(s));n.length>0?console.error("Missing required elements:",n):console.log("All required elements found"),this.fetchAndRender("all"),this.bindChartClicks(),this.bindModalClose(),console.log("AnalyticsPage init completed")}async fetchAndRender(a="all"){try{const s=await(await fetch("/analytics/data?period=all")).json();if(s.error)throw new Error(s.error);this.currentData=s,this.renderAll(s);const t=new Date().toLocaleString("id-ID",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"}),o=document.getElementById("last-updated");o&&(o.innerText=t)}catch(n){this.showError("Gagal memuat data analytics: "+n.message)}}renderAll(a){console.log("renderAll called with data:",a),this.updateData(a),this.updateSummaryCards(a.monthlyTrends)}renderMonthlyTrends(a){console.log("renderMonthlyTrends called with:",a);const n=document.getElementById("monthlyTrendsChart");if(!n){console.error("monthlyTrendsChart canvas not found");return}const s=(a||[]).map(l=>l.period),e=(a||[]).map(l=>l.sppd_count),t=(a||[]).map(l=>l.approved_count||0),o=(a||[]).map(l=>l.rejected_count||0),d=(a||[]).map(l=>l.in_review_count||0),i=(a||[]).map(l=>l.revision_count||0);console.log("Processed data:",{labels:s,totalSppd:e,approved:t,rejected:o,inReview:d,revision:i}),console.log("Using fixed chart type:","sppd_count");const p=[{label:"Disetujui",data:t,borderColor:"rgb(34, 197, 94)",backgroundColor:"rgba(34, 197, 94, 0.1)",tension:.4,borderWidth:3,pointBackgroundColor:"rgb(34, 197, 94)",pointBorderColor:"#ffffff",pointBorderWidth:2,pointRadius:6,pointHoverRadius:8,fill:!1,order:1},{label:"Ditolak",data:o,borderColor:"rgb(239, 68, 68)",backgroundColor:"rgba(239, 68, 68, 0.1)",tension:.4,borderWidth:3,pointBackgroundColor:"rgb(239, 68, 68)",pointBorderColor:"#ffffff",pointBorderWidth:2,pointRadius:6,pointHoverRadius:8,fill:!1,order:2},{label:"Dalam Review",data:d,borderColor:"rgb(245, 158, 11)",backgroundColor:"rgba(245, 158, 11, 0.1)",tension:.4,borderWidth:3,pointBackgroundColor:"rgb(245, 158, 11)",pointBorderColor:"#ffffff",pointBorderWidth:2,pointRadius:6,pointHoverRadius:8,fill:!1,order:3},{label:"Revisi",data:i,borderColor:"rgb(168, 85, 247)",backgroundColor:"rgba(168, 85, 247, 0.1)",tension:.4,borderWidth:3,pointBackgroundColor:"rgb(168, 85, 247)",pointBorderColor:"#ffffff",pointBorderWidth:2,pointRadius:6,pointHoverRadius:8,fill:!1,order:4},{label:"Total SPPD",data:e,borderColor:"rgba(59, 130, 246, 0.1)",backgroundColor:"transparent",tension:.4,borderWidth:1,pointBackgroundColor:"transparent",pointBorderColor:"rgba(59, 130, 246, 0.1)",pointBorderWidth:1,pointRadius:2,pointHoverRadius:3,fill:!1,order:5}];this.charts.monthlyTrends&&(console.log("Destroying existing monthlyTrends chart"),this.charts.monthlyTrends.destroy()),console.log("Creating new chart with datasets:",p),this.charts.monthlyTrends=new Chart(n,{type:"line",data:{labels:s,datasets:p},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"nearest",axis:"x",intersect:!1},plugins:{legend:{display:!0,position:"top",labels:{usePointStyle:!0,padding:15,font:{size:12}}},tooltip:{mode:"index",intersect:!1,backgroundColor:"rgba(0, 0, 0, 0.8)",titleColor:"#ffffff",bodyColor:"#ffffff",borderColor:"rgba(255, 255, 255, 0.2)",borderWidth:1,callbacks:{label:function(l){let c=l.dataset.label||"";return c&&(c+=": "),l.parsed.y!==null&&(c+=l.parsed.y+" SPPD"),c}}}},scales:{x:{display:!0,title:{display:!0,text:"Periode"},grid:{display:!1}},y:{display:!0,title:{display:!0,text:"Jumlah SPPD"},grid:{color:"rgba(0, 0, 0, 0.1)"},beginAtZero:!0}},elements:{point:{hoverRadius:8,radius:6},line:{tension:.4}}}}),this.updateSummaryCards(a),this.updateMonthlyInsight(a)}updateMonthlyInsight(a){if(!a||a.length===0)return;const n=a[a.length-1],s=a.length>1?a[a.length-2]:null,e=this.generateSppdCountInsight(n,s,a),t=document.getElementById("insight-monthly");t&&(t.innerHTML=e)}generateSppdCountInsight(a,n,s){const e=a.total_count||0,t=a.approved_count||0,o=a.rejected_count||0,d=a.in_review_count||0,i=a.revision_count||0;let r='<div class="space-y-3">';if(r+='<p class="text-gray-800 font-medium text-base">📊 <strong>Analisis Tren SPPD Bulanan:</strong></p>',r+='<div class="bg-gray-50 p-3 rounded-lg border border-gray-200">',r+=`<p class="text-gray-700 mb-2">Total SPPD periode ini: <span class="font-medium text-indigo-600">${e}</span> SPPD</p>`,r+='<div class="grid grid-cols-2 gap-2 text-sm">',r+='<div class="bg-green-50 p-2 rounded border border-green-200">',r+=`<span class="text-green-700">Disetujui:</span> <span class="font-medium text-green-700">${t}</span>`,r+="</div>",r+='<div class="bg-red-50 p-2 rounded border border-red-200">',r+=`<span class="text-red-700">Ditolak:</span> <span class="font-medium text-red-700">${o}</span>`,r+="</div>",r+='<div class="bg-amber-50 p-2 rounded border border-amber-200">',r+=`<span class="text-amber-700">Review:</span> <span class="font-medium text-amber-700">${d}</span>`,r+="</div>",r+='<div class="bg-purple-50 p-2 rounded border border-purple-200">',r+=`<span class="text-purple-700">Revisi:</span> <span class="font-medium text-purple-700">${i}</span>`,r+="</div>",r+="</div>",r+="</div>",n){const p=n.total_count||0,l=n.approved_count||0,c=n.rejected_count||0,g=p>0?((e-p)/p*100).toFixed(1):0,u=e>0?(t/e*100).toFixed(1):0,v=e>0?(o/e*100).toFixed(1):0,m=e>p,f=m?"text-green-600":"text-red-600",y=m?"↑":"↓";r+='<div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-3">',r+='<p class="text-gray-700 mb-2">Perbandingan dengan periode sebelumnya:</p>',r+='<div class="space-y-2 text-sm">',r+=`<p>Perubahan total SPPD: <span class="font-medium ${f}">${y} ${Math.abs(g)}%</span></p>`,r+=`<p>Tingkat persetujuan: <span class="font-medium text-green-600">${u}%</span></p>`,r+=`<p>Tingkat penolakan: <span class="font-medium text-red-600">${v}%</span></p>`;const h=t-l,b=o-c;r+='<div class="mt-2 pt-2 border-t border-gray-200">',r+='<p class="mb-1 text-gray-600">Perubahan detail:</p>',r+=`<p>SPPD disetujui: ${l} → ${t} `,h>0?r+=`<span class="text-green-600">(+${h})</span>`:h<0?r+=`<span class="text-red-600">(${h})</span>`:r+='<span class="text-gray-500">(tetap)</span>',r+="</p>",r+=`<p>SPPD ditolak: ${c} → ${o} `,b>0?r+=`<span class="text-red-600">(+${b})</span>`:b<0?r+=`<span class="text-green-600">(${b})</span>`:r+='<span class="text-gray-500">(tetap)</span>',r+="</p>",r+="</div>",r+="</div>",r+="</div>"}if(s.length>=3){const p=s.slice(-3),l=p.reduce((v,m)=>v+(m.total_count||0),0)/p.length;let c="",g="",u="";l>e*1.1?(c="menurun",g="text-red-600",u="Terjadi penurunan jumlah SPPD dibandingkan rata-rata 3 bulan terakhir. Hal ini mungkin menunjukkan pengurangan aktivitas perjalanan dinas atau perubahan kebijakan."):l<e*.9?(c="meningkat",g="text-green-600",u="Terjadi peningkatan jumlah SPPD dibandingkan rata-rata 3 bulan terakhir. Hal ini menunjukkan adanya peningkatan aktivitas perjalanan dinas."):(c="stabil",g="text-blue-600",u="Jumlah SPPD relatif stabil dibandingkan rata-rata 3 bulan terakhir. Hal ini menunjukkan konsistensi dalam aktivitas perjalanan dinas."),r+='<div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-3">',r+='<p class="text-gray-700 mb-2">Analisis tren 3 bulan terakhir:</p>',r+=`<p>Tren: <span class="font-medium ${g}">${c}</span> (rata-rata ${l.toFixed(1)} SPPD/bulan)</p>`,r+=`<p class="text-sm text-gray-600 mt-1">${u}</p>`,r+="</div>"}return r+="</div>",r}generateBudgetInsight(a,n,s){const e=a.total_budget||0,t=a.avg_budget_per_sppd||0,o=a.max_budget||0,d=a.min_budget||0;let i="💰 <strong>Analisis Tren Anggaran Bulanan:</strong><br>";if(i+=`• Total anggaran periode ini: <strong>Rp ${e.toLocaleString()}</strong><br>`,i+=`• Rata-rata anggaran per SPPD: <strong>Rp ${t.toLocaleString()}</strong><br>`,i+=`• Range anggaran: Rp ${d.toLocaleString()} - Rp ${o.toLocaleString()}<br>`,n){const p=((e-n.total_budget)/n.total_budget*100).toFixed(1);i+=`• Perubahan anggaran dari bulan lalu: <strong>${p}%</strong><br>`}const r=e>0?((a.approved_count||0)/(a.sppd_count||1)*100).toFixed(1):0;return i+=`• Efisiensi anggaran (approval rate): <strong>${r}%</strong>`,i}generateApprovalRateInsight(a,n,s){const e=a.approval_rate||0,t=a.sppd_count||0,o=a.approved_count||0;let d="✅ <strong>Analisis Tingkat Approval Bulanan:</strong><br>";if(d+=`• Tingkat approval periode ini: <strong>${e}%</strong><br>`,d+=`• Total SPPD: <strong>${t}</strong>, Disetujui: <strong>${o}</strong><br>`,n){const r=(e-n.approval_rate).toFixed(1),p=r>=0?"📈":"📉";d+=`• Perubahan tingkat approval: <strong>${p} ${r}%</strong><br>`}let i="";return e>=80?i="Sangat Baik":e>=60?i="Baik":e>=40?i="Cukup":i="Perlu Perbaikan",d+=`• Performa approval: <strong>${i}</strong>`,d}renderStatusDistribution(a){const n=document.getElementById("statusChart");if(!n)return;const s=Object.keys(a||{}),e=Object.values(a||{});this.charts.status&&this.charts.status.destroy(),this.charts.status=new Chart(n,{type:"doughnut",data:{labels:s,datasets:[{data:e,backgroundColor:["rgba(34, 197, 94, 0.8)","rgba(239, 68, 68, 0.8)","rgba(59, 130, 246, 0.8)","rgba(245, 158, 11, 0.8)","rgba(139, 92, 246, 0.8)"],borderWidth:2,borderColor:"#fff"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}}}}),s.length||this.showEmpty(n,"Tidak ada data status")}renderDepartmentAnalysis(a){const n=document.getElementById("departmentAnalysisChart");if(!n)return;const s=(a||[]).map(o=>o.department),e=(a||[]).map(o=>o.total_requests),t=(a||[]).map(o=>o.approved_count);this.charts.department&&this.charts.department.destroy(),this.charts.department=new Chart(n,{type:"bar",data:{labels:s,datasets:[{label:"Total SPPD",data:e,backgroundColor:"rgba(59, 130, 246, 0.4)"},{label:"Disetujui",data:t,backgroundColor:"rgba(34, 197, 94, 0.7)"}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0}},scales:{x:{beginAtZero:!0}}}}),s.length||this.showEmpty(n,"Tidak ada data departemen")}renderApprovalPerformance(a){const n=document.getElementById("approvalPerformanceChart");if(!n)return;const s=(a||[]).map(t=>t.approver_name),e=(a||[]).map(t=>t.total_approvals);this.charts.approval&&this.charts.approval.destroy(),this.charts.approval=new Chart(n,{type:"pie",data:{labels:s,datasets:[{data:e,backgroundColor:["rgba(59, 130, 246, 0.7)","rgba(34, 197, 94, 0.7)","rgba(245, 158, 11, 0.7)","rgba(239, 68, 68, 0.7)","rgba(139, 92, 246, 0.7)"]}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}}}}),s.length||this.showEmpty(n,"Tidak ada data approval")}renderTopDestinations(a){const n=document.getElementById("topDestinationsChart");if(!n)return;const s=(a||[]).map(t=>t.tujuan),e=(a||[]).map(t=>t.count);this.charts.destinations&&this.charts.destinations.destroy(),this.charts.destinations=new Chart(n,{type:"bar",data:{labels:s,datasets:[{label:"Jumlah Kunjungan",data:e,backgroundColor:"rgba(59, 130, 246, 0.4)"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0}}}}),s.length||this.showEmpty(n,"Tidak ada data destinasi")}renderBudgetUtilization(a){const n=document.getElementById("budgetUtilizationChart");if(!n||!a)return;const s=a.used||0;this.charts.budgetUtilization&&this.charts.budgetUtilization.destroy(),this.charts.budgetUtilization=new Chart(n,{type:"doughnut",data:{labels:["Total Anggaran"],datasets:[{data:[s],backgroundColor:["rgba(34, 197, 94, 0.8)"],borderWidth:2,borderColor:"#fff"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}}}})}updateData(a){var n,s,e,t;this.renderMonthlyTrends(a.monthlyTrends),this.renderStatusDistribution(a.statusDistribution),this.renderDepartmentAnalysis(a.departmentAnalysis),this.renderApprovalPerformance(a.approvalPerformance),this.renderTopDestinations((n=a.trendingData)==null?void 0:n.top_destinations),this.renderBudgetUtilization((s=a.overview)==null?void 0:s.budget_utilization),this.updateMonthlyInsight(a.monthlyTrends),this.updateStatusInsight(a.statusDistribution),this.updateDepartmentInsight(a.departmentAnalysis),this.updateApprovalInsight(a.approvalPerformance),this.updateDestinationInsight((e=a.trendingData)==null?void 0:e.top_destinations),this.updateBudgetUtilizationInsight((t=a.overview)==null?void 0:t.budget_utilization)}updateBudgetUtilizationInsight(a){if(!a){document.getElementById("insight-utilization").innerHTML="Belum ada data anggaran.";return}const n=a.used||0,s=this.formatCurrency(n);let e='<div class="space-y-3">';if(e+='<p class="text-gray-800 font-medium text-base">💰 <strong>Analisis Anggaran SPPD:</strong></p>',e+='<div class="bg-gray-50 p-3 rounded-lg border border-gray-200">',e+=`<p class="text-gray-700 mb-2">Total anggaran SPPD: <span class="font-medium text-indigo-600">${s}</span></p>`,a.total_sppd&&a.avg_per_sppd&&(e+='<div class="grid grid-cols-2 gap-2 text-sm mt-2">',e+='<div class="bg-blue-50 p-2 rounded border border-blue-200">',e+=`<span class="text-blue-700">Jumlah SPPD:</span> <span class="font-medium text-blue-700">${a.total_sppd}</span>`,e+="</div>",e+='<div class="bg-purple-50 p-2 rounded border border-purple-200">',e+=`<span class="text-purple-700">Rata-rata per SPPD:</span> <span class="font-medium text-purple-700">${this.formatCurrency(a.avg_per_sppd)}</span>`,e+="</div>",e+="</div>"),a.categories&&a.categories.length>0&&(e+='<div class="mt-3 pt-2 border-t border-gray-200">',e+='<p class="text-gray-700 mb-2">Distribusi anggaran:</p>',e+='<div class="overflow-x-auto">',e+='<table class="min-w-full text-sm">',e+='<thead><tr class="bg-gray-100">',e+='<th class="px-2 py-1 text-left">Kategori</th>',e+='<th class="px-2 py-1 text-right">Jumlah</th>',e+='<th class="px-2 py-1 text-right">Persentase</th>',e+="</tr></thead><tbody>",a.categories.forEach(o=>{const d=(o.amount/n*100).toFixed(1);e+='<tr class="border-t border-gray-200">',e+=`<td class="px-2 py-1">${o.name}</td>`,e+=`<td class="px-2 py-1 text-right">${this.formatCurrency(o.amount)}</td>`,e+=`<td class="px-2 py-1 text-right">${d}%</td>`,e+="</tr>"}),e+="</tbody></table>",e+="</div>",e+="</div>"),a.previous_total){const o=a.previous_total||0,d=n-o,i=o>0?(d/o*100).toFixed(1):0,r=d>=0,p=r?"text-green-600":"text-red-600",l=r?"↑":"↓",c=r?"meningkat":"menurun";e+='<div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-3">',e+='<p class="text-gray-700 mb-2">Perbandingan dengan periode sebelumnya:</p>',e+='<div class="space-y-2 text-sm">',e+=`<p>Perubahan total anggaran: <span class="font-medium ${p}">${l} ${Math.abs(i)}%</span></p>`,e+=`<p>Perubahan nominal: <span class="font-medium ${p}">${this.formatCurrency(Math.abs(d))}</span></p>`,e+='<div class="mt-2 pt-2 border-t border-gray-200">',e+=`<p class="text-sm text-gray-600">Anggaran SPPD ${c} sebesar ${this.formatCurrency(Math.abs(d))} (${Math.abs(i)}%) dibandingkan periode sebelumnya. `,r?e+="Peningkatan ini menunjukkan adanya kenaikan aktivitas perjalanan dinas atau kenaikan biaya perjalanan rata-rata.</p>":e+="Penurunan ini menunjukkan adanya pengurangan aktivitas perjalanan dinas atau efisiensi dalam biaya perjalanan.</p>",e+="</div>",e+="</div>",e+="</div>"}e+="</div>",e+="</div>";const t=document.getElementById("insight-utilization");t&&(t.innerHTML=e)}updateStatusInsight(a){if(!a||Object.keys(a).length===0){document.getElementById("insight-status").innerHTML="Belum ada data status.";return}const s=[...Object.entries(a).map(([l,c])=>({status:l,count:c}))].sort((l,c)=>c.count-l.count),e=s.reduce((l,c)=>l+c.count,0);let t='<div class="space-y-3">';t+='<p class="text-gray-800 font-medium text-base">📋 <strong>Analisis Status SPPD:</strong></p>',t+='<div class="bg-gray-50 p-3 rounded-lg border border-gray-200">',t+=`<p class="text-gray-700 mb-2">Total SPPD: <span class="font-medium text-indigo-600">${e}</span></p>`,t+='<div class="overflow-x-auto mt-2">',t+='<table class="min-w-full text-sm">',t+='<thead><tr class="bg-gray-100">',t+='<th class="px-2 py-1 text-left">Status</th>',t+='<th class="px-2 py-1 text-right">Jumlah</th>',t+='<th class="px-2 py-1 text-right">Persentase</th>',t+="</tr></thead><tbody>";const o={Disetujui:"bg-green-50 text-green-700",Ditolak:"bg-red-50 text-red-700","Dalam Review":"bg-amber-50 text-amber-700",Revisi:"bg-purple-50 text-purple-700",Draft:"bg-gray-50 text-gray-700"};s.forEach(l=>{const c=(l.count/e*100).toFixed(1),g=o[l.status]||"bg-gray-50 text-gray-700";t+=`<tr class="border-t border-gray-200 ${g}">`,t+=`<td class="px-2 py-1">${l.status}</td>`,t+=`<td class="px-2 py-1 text-right font-medium">${l.count}</td>`,t+=`<td class="px-2 py-1 text-right">${c}%</td>`,t+="</tr>"}),t+="</tbody></table>",t+="</div>",t+="</div>";const d=s.find(l=>l.status==="Disetujui"),i=s.find(l=>l.status==="Ditolak"),r=s.find(l=>l.status==="Dalam Review");if(d||i){t+='<div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-3">',t+='<p class="text-gray-700 mb-2">Analisis tingkat persetujuan:</p>';const l=d?(d.count/e*100).toFixed(1):0,c=i?(i.count/e*100).toFixed(1):0,g=r?(r.count/e*100).toFixed(1):0;if(t+='<div class="space-y-2 text-sm">',d&&(t+=`<p>Tingkat persetujuan: <span class="font-medium text-green-600">${l}%</span></p>`),i&&(t+=`<p>Tingkat penolakan: <span class="font-medium text-red-600">${c}%</span></p>`),r&&(t+=`<p>Dalam proses review: <span class="font-medium text-amber-600">${g}%</span></p>`),t+='<div class="mt-2 pt-2 border-t border-gray-200">',t+='<p class="text-sm text-gray-600">',d&&i)if(d.count>i.count){const u=(d.count/(i.count||1)).toFixed(1);t+=`Tingkat persetujuan ${l}% lebih tinggi dibandingkan tingkat penolakan ${c}%. `,t+=`Rasio persetujuan:penolakan adalah ${u}:1, menunjukkan mayoritas SPPD disetujui.`}else if(i.count>d.count){const u=(i.count/(d.count||1)).toFixed(1);t+=`Tingkat penolakan ${c}% lebih tinggi dibandingkan tingkat persetujuan ${l}%. `,t+=`Rasio penolakan:persetujuan adalah ${u}:1, menunjukkan mayoritas SPPD ditolak.`}else t+=`Tingkat persetujuan dan penolakan seimbang pada ${l}%, menunjukkan distribusi yang merata.`;else d?t+=`Tingkat persetujuan ${l}% dengan tidak ada penolakan, menunjukkan semua SPPD yang diproses telah disetujui.`:i&&(t+=`Tingkat penolakan ${c}% dengan tidak ada persetujuan, menunjukkan semua SPPD yang diproses telah ditolak.`);t+="</p>",t+="</div>",t+="</div>",t+="</div>"}t+="</div>";const p=document.getElementById("insight-status");p&&(p.innerHTML=t)}updateDepartmentInsight(a){if(!a||a.length===0){document.getElementById("insight-department").innerHTML="Belum ada data departemen.";return}const n=[...a].sort((i,r)=>r.total_requests-i.total_requests),s=n[0],e=n.reduce((i,r)=>i+r.total_requests,0);let t='<div class="space-y-3">';t+='<p class="text-gray-800 font-medium text-base">🏢 <strong>Analisis Departemen:</strong></p>',t+='<div class="bg-gray-50 p-3 rounded-lg border border-gray-200">',t+=`<p class="text-gray-700 mb-2">Total SPPD dari semua departemen: <span class="font-medium text-indigo-600">${e}</span></p>`;const o=s.total_requests>0?(s.approved_count/s.total_requests*100).toFixed(1):0;if(t+='<div class="bg-blue-50 p-2 rounded border border-blue-200 mt-2">',t+=`<p class="text-blue-700 font-medium">Departemen Teratas: ${s.department}</p>`,t+='<div class="grid grid-cols-2 gap-2 text-sm mt-1">',t+=`<div><span class="text-gray-600">Total SPPD:</span> <span class="font-medium">${s.total_requests}</span></div>`,t+=`<div><span class="text-gray-600">Disetujui:</span> <span class="font-medium text-green-600">${s.approved_count}</span></div>`,t+=`<div><span class="text-gray-600">Tingkat persetujuan:</span> <span class="font-medium">${o}%</span></div>`,t+=`<div><span class="text-gray-600">Persentase dari total:</span> <span class="font-medium">${(s.total_requests/e*100).toFixed(1)}%</span></div>`,t+="</div>",t+="</div>",t+='<div class="overflow-x-auto mt-3">',t+='<table class="min-w-full text-sm">',t+='<thead><tr class="bg-gray-100">',t+='<th class="px-2 py-1 text-left">Departemen</th>',t+='<th class="px-2 py-1 text-right">Total</th>',t+='<th class="px-2 py-1 text-right">Disetujui</th>',t+='<th class="px-2 py-1 text-right">Tingkat</th>',t+="</tr></thead><tbody>",n.slice(0,5).forEach(i=>{const r=i.total_requests>0?(i.approved_count/i.total_requests*100).toFixed(1):0;t+='<tr class="border-t border-gray-200">',t+=`<td class="px-2 py-1">${i.department}</td>`,t+=`<td class="px-2 py-1 text-right">${i.total_requests}</td>`,t+=`<td class="px-2 py-1 text-right">${i.approved_count}</td>`,t+=`<td class="px-2 py-1 text-right">${r}%</td>`,t+="</tr>"}),t+="</tbody></table>",t+="</div>",t+='<div class="mt-3 pt-2 border-t border-gray-200">',t+='<p class="text-sm text-gray-600">',t+=`Departemen ${s.department} memiliki jumlah SPPD tertinggi dengan ${s.total_requests} permintaan `,t+=`(${(s.total_requests/e*100).toFixed(1)}% dari total). `,n.length>1){const i=n[1],p=((s.total_requests-i.total_requests)/i.total_requests*100).toFixed(1);t+=`Jumlah ini ${p}% lebih tinggi dibandingkan departemen ${i.department} `,t+=`yang berada di posisi kedua dengan ${i.total_requests} permintaan.`}t+="</p>",t+="</div>",t+="</div>",t+="</div>";const d=document.getElementById("insight-department");d&&(d.innerHTML=t)}updateApprovalInsight(a){if(!a||a.length===0){document.getElementById("insight-approval").innerHTML="Belum ada data approval.";return}const n=[...a].sort((d,i)=>i.total_approvals-d.total_approvals),s=n[0],e=n.reduce((d,i)=>d+i.total_approvals,0);let t='<div class="space-y-3">';if(t+='<p class="text-gray-800 font-medium text-base">✅ <strong>Analisis Performa Approval:</strong></p>',t+='<div class="bg-gray-50 p-3 rounded-lg border border-gray-200">',t+=`<p class="text-gray-700 mb-2">Total approval: <span class="font-medium text-indigo-600">${e}</span></p>`,t+='<div class="bg-green-50 p-2 rounded border border-green-200 mt-2">',t+=`<p class="text-green-700 font-medium">Approver Teratas: ${s.approver_name}</p>`,t+='<div class="grid grid-cols-2 gap-2 text-sm mt-1">',t+=`<div><span class="text-gray-600">Total approval:</span> <span class="font-medium">${s.total_approvals}</span></div>`,t+=`<div><span class="text-gray-600">Persentase dari total:</span> <span class="font-medium">${(s.total_approvals/e*100).toFixed(1)}%</span></div>`,s.avg_time_to_approve&&(t+=`<div><span class="text-gray-600">Rata-rata waktu approval:</span> <span class="font-medium">${s.avg_time_to_approve}</span></div>`),t+="</div>",t+="</div>",t+='<div class="overflow-x-auto mt-3">',t+='<table class="min-w-full text-sm">',t+='<thead><tr class="bg-gray-100">',t+='<th class="px-2 py-1 text-left">Approver</th>',t+='<th class="px-2 py-1 text-right">Total</th>',t+='<th class="px-2 py-1 text-right">Persentase</th>',t+="</tr></thead><tbody>",n.forEach(d=>{const i=(d.total_approvals/e*100).toFixed(1);t+='<tr class="border-t border-gray-200">',t+=`<td class="px-2 py-1">${d.approver_name}</td>`,t+=`<td class="px-2 py-1 text-right">${d.total_approvals}</td>`,t+=`<td class="px-2 py-1 text-right">${i}%</td>`,t+="</tr>"}),t+="</tbody></table>",t+="</div>",n.length>1){t+='<div class="mt-3 pt-2 border-t border-gray-200">',t+='<p class="text-sm text-gray-600">',t+=`${s.approver_name} telah melakukan ${s.total_approvals} approval `,t+=`(${(s.total_approvals/e*100).toFixed(1)}% dari total). `;const d=n[1],r=((s.total_approvals-d.total_approvals)/d.total_approvals*100).toFixed(1);t+=`Jumlah ini ${r}% lebih tinggi dibandingkan ${d.approver_name} `,t+=`yang berada di posisi kedua dengan ${d.total_approvals} approval.`,t+="</p>",t+="</div>"}t+="</div>",t+="</div>";const o=document.getElementById("insight-approval");o&&(o.innerHTML=t)}updateDestinationInsight(a){if(!a||a.length===0){document.getElementById("insight-destination").innerHTML="Belum ada data destinasi.";return}const n=a[0],s=a.reduce((o,d)=>o+d.count,0);let e='<div class="space-y-3">';if(e+='<p class="text-gray-800 font-medium text-base">🌍 <strong>Analisis Destinasi SPPD:</strong></p>',e+='<div class="bg-gray-50 p-3 rounded-lg border border-gray-200">',e+=`<p class="text-gray-700 mb-2">Total perjalanan: <span class="font-medium text-indigo-600">${s}</span></p>`,e+='<div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2">',e+=`<p class="text-amber-700 font-medium">Destinasi Terpopuler: ${n.tujuan}</p>`,e+='<div class="grid grid-cols-2 gap-2 text-sm mt-1">',e+=`<div><span class="text-gray-600">Jumlah kunjungan:</span> <span class="font-medium">${n.count}</span></div>`,e+=`<div><span class="text-gray-600">Persentase dari total:</span> <span class="font-medium">${(n.count/s*100).toFixed(1)}%</span></div>`,e+="</div>",e+="</div>",e+='<div class="overflow-x-auto mt-3">',e+='<table class="min-w-full text-sm">',e+='<thead><tr class="bg-gray-100">',e+='<th class="px-2 py-1 text-left">Destinasi</th>',e+='<th class="px-2 py-1 text-right">Jumlah</th>',e+='<th class="px-2 py-1 text-right">Persentase</th>',e+="</tr></thead><tbody>",a.slice(0,5).forEach(o=>{const d=(o.count/s*100).toFixed(1);e+='<tr class="border-t border-gray-200">',e+=`<td class="px-2 py-1">${o.tujuan}</td>`,e+=`<td class="px-2 py-1 text-right">${o.count}</td>`,e+=`<td class="px-2 py-1 text-right">${d}%</td>`,e+="</tr>"}),e+="</tbody></table>",e+="</div>",e+='<div class="mt-3 pt-2 border-t border-gray-200">',e+='<p class="text-sm text-gray-600">',e+=`${n.tujuan} merupakan destinasi paling populer dengan ${n.count} kunjungan `,e+=`(${(n.count/s*100).toFixed(1)}% dari total perjalanan). `,a.length>1){const o=a[1],i=((n.count-o.count)/o.count*100).toFixed(1);e+=`Jumlah ini ${i}% lebih tinggi dibandingkan ${o.tujuan} `,e+=`yang berada di posisi kedua dengan ${o.count} kunjungan.`}e+="</p>",e+="</div>",e+="</div>",e+="</div>";const t=document.getElementById("insight-destination");t&&(t.innerHTML=e)}formatCurrency(a){return new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(a)}showEmpty(a,n){if(a&&a.parentNode){a.parentNode.querySelectorAll(".empty-chart-msg").forEach(e=>e.remove());const s=document.createElement("div");s.className="empty-chart-msg",s.style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#888;text-align:center;z-index:10;pointer-events:none;",s.innerText=n,a.parentNode.appendChild(s)}}showError(a){alert(a)}bindChartClicks(){const a=document.getElementById("monthlyTrendsChart");a&&(a.onclick=i=>{const r=this.charts.monthlyTrends.getElementsAtEventForMode(i,"nearest",{intersect:!0},!0);if(r.length){const p=r[0].index,l=this.charts.monthlyTrends.data.labels[p];this.showDetailModal("monthly",{period:l})}});const n=document.getElementById("budgetTrendsChart");n&&(n.onclick=i=>{const r=this.charts.budgetTrends.getElementsAtEventForMode(i,"nearest",{intersect:!0},!0);if(r.length){const p=r[0].index,l=this.charts.budgetTrends.data.labels[p];this.showDetailModal("budget",{period:l})}});const s=document.getElementById("statusChart");s&&(s.onclick=i=>{const r=this.charts.status.getElementsAtEventForMode(i,"nearest",{intersect:!0},!0);if(r.length){const p=r[0].index,l=this.charts.status.data.labels[p];this.showDetailModal("status",{status:l})}});const e=document.getElementById("departmentAnalysisChart");e&&(e.onclick=i=>{const r=this.charts.department.getElementsAtEventForMode(i,"nearest",{intersect:!0},!0);if(r.length){const p=r[0].index,l=this.charts.department.data.labels[p];this.showDetailModal("department",{department:l})}});const t=document.getElementById("approvalPerformanceChart");t&&(t.onclick=i=>{const r=this.charts.approval.getElementsAtEventForMode(i,"nearest",{intersect:!0},!0);if(r.length){const p=r[0].index,l=this.charts.approval.data.labels[p];this.showDetailModal("approval",{approver:l})}});const o=document.getElementById("topDestinationsChart");o&&(o.onclick=i=>{const r=this.charts.destinations.getElementsAtEventForMode(i,"nearest",{intersect:!0},!0);if(r.length){const p=r[0].index,l=this.charts.destinations.data.labels[p];this.showDetailModal("destination",{tujuan:l})}});const d=document.getElementById("budgetUtilizationChart");d&&(d.onclick=()=>{this.showDetailModal("utilization",{})})}showDetailModal(a,n){const s=document.getElementById("analytics-modal"),e=document.getElementById("analytics-modal-content");s.classList.remove("hidden"),e.innerHTML="<div class='text-center text-lg font-bold mb-4'>Memuat detail...</div>",e.dataset.detailType=a,e.dataset.detailParams=JSON.stringify(n);const t=new URL("/analytics/detail",window.location.origin);t.searchParams.set("type",a),Object.entries(n).forEach(([o,d])=>t.searchParams.set(o,d)),fetch(t).then(o=>o.json()).then(o=>{let d=`<div class='text-xl font-bold mb-2'>${o.title}</div>`;o.columns&&o.columns.length?(d+="<div class='overflow-x-auto'><table class='min-w-full text-sm border rounded-lg'>",d+=`<thead><tr>${o.columns.map(i=>`<th class='px-3 py-2 bg-slate-100 border-b text-left'>${i}</th>`).join("")}</tr></thead>`,d+="<tbody>",o.data&&o.data.length?o.data.forEach(i=>{d+=`<tr>${i.map(r=>`<td class='px-3 py-2 border-b'>${r}</td>`).join("")}</tr>`}):d+=`<tr><td colspan='${o.columns.length}' class='text-center py-4 text-gray-400'>Tidak ada data.</td></tr>`,d+="</tbody></table></div>"):d+="<div class='text-gray-400 text-center py-8'>Tidak ada data detail.</div>",e.innerHTML=d}).catch(()=>{e.innerHTML="<div class='text-red-500 text-center py-8'>Gagal memuat detail data.</div>"})}bindModalClose(){const a=document.getElementById("analytics-modal"),n=document.getElementById("close-analytics-modal");n&&(n.onclick=()=>{a.classList.add("hidden")}),a.addEventListener("click",s=>{s.target===a&&a.classList.add("hidden")})}updateSummaryCards(a){if(console.log("updateSummaryCards called with:",a),!a||a.length===0){console.log("No monthly trends data available");return}const n=a[a.length-1];if(console.log("Latest data:",n),a.length>=2){const s=a[a.length-2];console.log("Previous data:",s);const e=this.calculateChange(n.sppd_count,s.sppd_count),t=this.calculateChange(n.approved_count,s.approved_count),o=this.calculateChange(n.rejected_count,s.rejected_count),d=this.calculateChange(n.in_review_count,s.in_review_count);console.log("Changes calculated:",{totalChange:e,approvedChange:t,rejectedChange:o,reviewChange:d}),this.updateCard("total-sppd",n.sppd_count,e,"total-change"),this.updateCard("approved-sppd",n.approved_count,t,"approved-change"),this.updateCard("rejected-sppd",n.rejected_count,o,"rejected-change"),this.updateCard("review-sppd",n.in_review_count,d,"review-change")}else console.log("Only one data point available, showing current values with 0% change"),this.updateCard("total-sppd",n.sppd_count,"0%","total-change"),this.updateCard("approved-sppd",n.approved_count,"0%","approved-change"),this.updateCard("rejected-sppd",n.rejected_count,"0%","rejected-change"),this.updateCard("review-sppd",n.in_review_count,"0%","review-change")}calculateChange(a,n){if(n===0)return a>0?"+100%":"0%";const s=(a-n)/n*100;return s>=0?`+${s.toFixed(1)}%`:`${s.toFixed(1)}%`}updateCard(a,n,s,e){console.log(`updateCard called: ${a} = ${n}, ${e} = ${s}`);const t=document.getElementById(a),o=document.getElementById(e);console.log("Card element found:",!!t),console.log("Change element found:",!!o),t?(t.textContent=n||0,console.log(`Updated ${a} to:`,n||0)):console.error(`Card element not found: ${a}`),o?(o.textContent=s,s.startsWith("+")?o.className="text-xs text-green-600":s.startsWith("-")?o.className="text-xs text-red-600":o.className="text-xs text-gray-500",console.log(`Updated ${e} to:`,s)):console.error(`Change element not found: ${e}`)}}document.getElementById("monthlyTrendsChart")&&(window.analyticsPage=new x);
